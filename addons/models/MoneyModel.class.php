<?php/** * pu币模型 * * @author nonant */class MoneyModel extends Model {    protected $tableName = 'money';    public function getMoneyDb($uid){        $money = $this->getField('money', 'uid='.$uid);        if(!$money){            return 0;        }        return $money;    }    public function getMoneyCache($uid){        $userInfo = S('S_userInfo_'.$uid);        if(empty($userInfo)) {            return $this->getMoneyDb($uid);        }        $userInfo['money'] = $this->getMoneyDb($uid);        S('S_userInfo_'.$uid, $userInfo);        if(isset($_SESSION['userInfo']) && $_SESSION['mid'] == $uid){            $_SESSION['userInfo']['money'] = $userInfo['money'];        }        return $userInfo['money'];    }    public function moneyOut($uid, $out, $title, $url=''){        $money = $this->getMoneyCache($uid);        if(!$money || $money<$out || $out<=0){            return false;        }elseif($this->setDec('money', 'uid='.$uid, $out)){            $this->getMoneyCache($uid);            $data['out_uid'] = $uid;            $data['out_title'] = $title;            $data['out_money'] = $out;            $data['out_url'] = $url;            $data['out_ctime'] = time();            M('money_out')->add($data);            return true;        }        return false;    }    public function moneyIn($uid, $total_fee, $title){        if($total_fee<=0){            return $this->getMoneyCache($uid);        }        //充值记录        $rechargedata = array(                'uid'=>$uid,                'typeName'=>$title,                'logMoney'=>$total_fee,                'ctime'=>time()        );        M('money_in')->add($rechargedata);        return $this->incMoney($uid, $total_fee);//加钱    }    //充钱 订单号，钱，人    public function moneyBank($out_trade_no,$total_fee,$uid){        $has = M('money_trade')->where('out_trade_no='.$out_trade_no.' and uid='.$uid)->find();        if($has){            return true;        }        $trade_data = array(            'out_trade_no'=>$out_trade_no,            'money'=>$total_fee,            'ctime'=>time()        );        M('money_trade')->add($trade_data);        //充值记录        $rechargedata = array(                'uid'=>$uid,                'typeName'=>'财付通',                'logMoney'=>$total_fee,                'ctime'=>time()        );        M('money_in')->add($rechargedata);        return $this->incMoney($uid, $total_fee);//加钱    }    public function incMoney($uid, $total_fee){        $money = $this->getField('uid', 'uid='.$uid);        if(!$money){            $data = array(                'uid'=>$uid,                'money'=>$total_fee            );            $this->add($data);        }else{            $this->setInc('money', 'uid='.$uid, $total_fee);        }        return $this->getMoneyCache($uid);    }}